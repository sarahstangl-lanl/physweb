
<%DOC>
   Component: tourpins.html
        Date: 2008.06.12
      Author: nick
     Changed: 2008.06.12 by nick

 Description: Shows door PINs that have been generated by door management script
</%DOC>

<%ARGS>
</%ARGS>

<%INIT>

$m->comp('/mason/auth/auth_block.comp');
my $authorized = $m->comp('/mason/auth/auth_check_directory.comp');
my $admin_auth = $m->comp('/mason/auth/auth_check_sysadm.comp');
my $doormgr = $m->comp('/mason/auth/auth_check_door_mgr.comp');
if (!$authorized && !$doormgr && !$admin_auth) { print "<H2>You do not have permission to view this page</H2>"; return; }
my $even = 0;
my $query;
if (!$authorized && !$admin_auth) {
  $query = $dbh->prepare("SELECT doorlocks.name,doorlocks.pin,doorlocks.next_pin FROM doorlocks JOIN groupmembers ON doorlocks.name = groupmembers.groupname AND groupmembers.manager = 1 AND groupmembers.uid = ?");
  $query->execute($session{uid}) or die "Couldn't execute query: ".$query->errstr;
} else {
  $query = $dbh->prepare("SELECT name,pin,next_pin FROM doorlocks WHERE pin <> ''");
  $query->execute() or die "Couldn't execute query: ".$query->errstr;
}
if ($admin_auth) { print "[<a href=\"index.html\" title=\"Door Management\">Door Management</a>]"; }
print "<p><table><tr class=\"tablehead\"><th width=\"130\">Door Name</th><th width=\"100\">PIN</th><th width=\"100\">Next PIN</th></tr>\n";
while(my ($door,$pin,$nextpin) = $query->fetchrow_array()) {
  print "<tr class=\"".($even ? 'even' : 'odd')."\"><td align=\"center\">$door</td><td align=\"center\">$pin</td><td align=\"center\">$nextpin</td></tr>\n";
  $even = $even ? 0 : 1;
}
print "</table>\n";
</%INIT>		
		
<%method title>Door PINs</%method>
